"use strict";(async function(){let t=require("request");let r=require("fs");let n=require("readline");let i=require("crypto");let o=require("util");let a=function(e,i,o){o=Array.from(o);return new Promise(function(t,r){let n=false;for(let e=0;e<o.length;e++){if(o[e]===a.callback){n=true;o[e]=function(){t(arguments)}}}if(!n){o.push(function(){t(arguments)})}try{e.apply(i,o)}catch(e){r(e)}})};let u=function(e){process.stdout.write(e);return new Promise(function(t){let r=n.createInterface({input:process.stdin});r.on("line",function(e){r.close();t(e)})})};Object.defineProperty(Array.prototype,"len",{get:function(){return this.length}});Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]}});let s=function e(r=0,n,i=1){if(arguments.length==1){n=r;r=0}return{[Symbol.iterator](){let t=r;return{next:function(){let e;if(t<n){e={value:t,done:false}}else{e={value:undefined,done:true}}t+=i;return e}}}}};let f=function(...t){let r;for(let e in t){r=t[e];if(r instanceof Buffer){let t=false;for(let e of r){if(e>127){t=true;break}}if(t){r=r.toString("hex")}else{r=r.toString()}r="Buffer["+r+"]"}if(typeof r==="string"||typeof r==="number"||r instanceof Number||r instanceof String){r=r.toString()}else{try{r=JSON.stringify(r,null,4)}catch(e){r=r.toString()}}t[e]=r}console.log.apply(console,t)};let l=function(t){return new Promise(function(e){setTimeout(e,t)})};String.prototype.format=function(...e){e.unshift(String(this));return o.format.apply(o,e)};let e=function(e){return Buffer.from(e).toString("base64")};let c=function(e){return Buffer.from(e,"base64").toString()};let d=class e{constructor(e=1){let t=this;this.counter=e;let r;this.promise=new Promise(function(e){r=e});t.promise.resolve=r;if(e<=0){r()}}resolve(e=1){this.counter-=e;if(this.counter<=0){this.promise.resolve()}}resolveAll(e){self.promise.resolve(e)}};let h=function(i,e=64){let o=[],s=0;let t=async function(r,n={}){if(s>e){let e=new d;o.push(e);await e.promise}if(!n.stream){s++;let t=await a(i,this,[r,n]);s--;if(o.length){o.shift().resolve()}if(t[0]){return[t[0],undefined]}if(t[1].statusCode>=400){let e=new Error("HTTP(S) request error "+t[1].statusCode+": "+t[1].statusMessage);e.statusMessage=t[1].statusMessage;e.statusCode=t[1].statusCode;e.response=t[1];e.body=t[2];return[e,undefined]}if(n.parseJSON){try{t[2]=JSON.parse(t[2])}catch(e){return[e,undefined]}}return[false,t[2]]}else{let t=s;try{s++;let e=i(r,n);e.on("close",function(){s--});return[false,e]}catch(e){s=t;return[e,undefined]}}};return t};let p=function(t){t=t.trim();let r=["/／",":：","*﹡","?？",'"”',"<﹤",">﹤","|∣"];for(let e of s(r.len)){t=t.replaceAll(r[e][0],r[e][1])}return t};let m=function(e){try{r.mkdirSync(p(e),{recursive:true})}catch(e){}};let w=async function(e){if(e!==0&&e&7){f("Retry in 1 seconds.");await l(1e3)}else{if((await u("Retry? (Y/N): ")).toLowerCase()==="n"){return false}}return true};let y=function(t){let r="",n;for(let e in t){n=t[e];if(n instanceof Buffer){let t=false;for(let e of n){if(e>127){t=true;break}}if(t){n=n.toString("base64")}else{n=n.toString()}}if(typeof n==="string"||typeof n==="number"||n instanceof Number||n instanceof String){n=n.toString()}else{try{n=JSON.stringify(n)}catch(e){n=n.toString()}}r+=encodeURIComponent(e)+"="+encodeURIComponent(n)+"&"}return r.slice(0,-1)};let g=async function(e,t,r){let n=await e("https://abook.hep.com.cn/loginMobile.action",{body:y({device:"iPhone","loginUser.loginName":t,"loginUser.loginPassword":i.createHash("md5").end(r).digest().toString("hex"),packageId:"com.hep.abook",passType:"MD5",version:"v1.182"}),headers:{"User-Agent":"iPhone","Content-Type":"application/x-www-form-urlencoded"},method:"post",parseJSON:true});if(n[0]){return n[0]}try{if(n[1][0]["message"]=="successful"){return false}else{return n[1][0]["message"]}}catch(e){return e}};let I=async function(e){let r=await e("https://abook.hep.com.cn/selectMyCourseList.action?mobile=true&cur=1",{parseJSON:true});if(!r[0]){try{r=r[1][0].myMobileCourseList;let t=[];for(let e in r){t[e]=[r[e].courseInfoId,r[e].courseTitle];t[r[e].courseInfoId]=[e,r[e].courseTitle]}return[false,t]}catch(e){return[e,undefined]}}return[r[0],undefined]};let b=function(e,t){t=-0;let r={haveMenu:false,name:"root",pId:-1,id:-t,type:-1},n=e,i={};n.push(r);for(let e of n){e.path=[];e.children=[];e.childrenById={};e.serializable={name:e.name,id:e.id,children:[]};i[e.id]=e;if(e.pId===0){e.pId=-t}}for(let e of n){if(e===r){e.parent=null;continue}i[e.pId].serializable.children.push(e.serializable);i[e.pId].children.push(e);i[e.pId].childrenById[e.id]=e;e.parent=i[e.pId];delete e.pId}for(let t of n){let e=t;while(e!==r){t.path.unshift(p(e.name));e=e.parent}}i[0]=r;return[r,n,i]};let S=async function(e,t){let r=await e("https://abook.hep.com.cn/resourceStructure.action?courseInfoId=%s".format(t),{parseJSON:true});return r[0]?[r[0],undefined]:[false,b(r[1],t)]};let k=async function(r,e,t,n,i=w){let o="https://abook.hep.com.cn/courseResourceList.action?courseInfoId=%s&treeId=%s&cur=".format(e,t.id);let s=Infinity,a=[],l;for(let t=1;t<=s;t++){for(let e=1;[l=await r(o+t,{parseJSON:true}),l[0]].last;e++){if(!await i(e)){return[l[0],undefined]}}if(l[1][0].message===c("6K+l5YaF5a656K+35Zyo55S16ISR56uv5p+l55yL44CC")){a="needDesktop";break}if(l[1][0].message===c("6K+l55uu5b2V5LiL5peg5YaF5a6544CC6K+354K55Ye75Y+z5L6n566t5aS05bGV5byA5ZCO5rWP6KeI5LiL5LiA57qn6IqC54K555qE5pyJ5YWz5YaF5a6544CC")){return[]}if(l[1][0].message!==c("5Yqg6L295oiQ5Yqf")){f(l[1][0].message);throw"TODO"}s=l[1][0].page.pageCount;a=a.concat(l[1][0].myMobileResourceList)}if(a==="needDesktop"){f("TODO",t.serializable);return[];throw"TODO"}else{for(let e of a){if(n[e.resourceInfoId]){e.resFileUrl=n[e.resourceInfoId]}l=e.resFileUrl.indexOf(".");if(l!==-1){e.format=e.resFileUrl.slice(l+1)}else{e.format=""}e.path=t.path}}return[false,a]};let v=async function(r,n,t,i,o=w){for(let e=1,t;(t=await r("https://abook.hep.com.cn/enterCourse.action?courseInfoId=%s&roleGroupId=4&ishaveEdit=0".format(n)))[0];e++){log("Failed to enter course %s.".format(n));if(!await o(e)){return[t[0],undefined]}}let s=[];if(t.type===1){let e=await k(r,n,t,i,o);if(e[0]){return[e[0],undefined]}s=s.concat(e[1])}let a=new d(t.children.len);for(let e of t.children){v(r,n,e,i,o).then(function(e){if(e[1]){s=s.concat(e[1])}a.resolve()})}await a.promise;return[false,s]};let C=async function(r,n,i=f,o=w){for(let e=1,t;(t=await r("https://abook.hep.com.cn/enterCourse.action?courseInfoId=%s&roleGroupId=4&ishaveEdit=0".format(n)))[0];e++){i("Failed to enter course %s.".format(n));if(!await o(e)){return[t[0],undefined]}}let s={},a,l;for(let e=1;[a=await r("https://abook.hep.com.cn/AjaxSelectMyResource.action?treeId=0&show=largeIcons&ifUser=resList&cur=1"),a[0]].last;e++){if(!await o(e)){return[a[0],undefined]}}for(let e of a[1].match(/<input type="hidden" id="hid[0-9]+" value=".*"\/>/g)){l=e.indexOf('" value="');s[e.slice(28,l)]=e.slice(l+9,-3)}let e=Number(a[1].match(/<input type='hidden' name='page.pageCount' value='[0-9]+/)[0].slice(50)),u=new d(e-1);for(let t=2;t<=e;t++){setImmediate(async function(){for(let e=1;[a=await r("https://abook.hep.com.cn/AjaxSelectMyResource.action?treeId=0&show=largeIcons&ifUser=resList&cur="+t),a[0]].last;e++){if(!await o(e)){u.resolveAll(a[0])}}for(let e of a[1].match(/<input type="hidden" id="hid[0-9]+" value=".*"\/>/g)){l=e.indexOf('" value="');s[e.slice(28,l)]=e.slice(l+9,-3)}u.resolve()})}if(a=await u.promise){return[a,undefined]}return[false,s]};let F=async function(t,r,n=f,i=w){let o;n("Fetching resource structure.");for(let e=1;o=await S(t,r),o[0];e++){n("Failed to fetched resource structure.");if(!await i(e)){return[o[0],undefined]}}o=o[1];n("Successfully fetched resource structure.");n("Fetching download links.");let e=await C(t,r);if(e[0]){f("Failed to fetch download links.");return[e[0],undefined]}e=e[1];n("Successfully fetched download links.");n("Fetching resource information. This may take up to a minute.");let s=await v(t,r,o[0],e);if(s[0]){f("Failed to fetch resource information.");return[s[0],undefined]}return[false,s[1]]};let O=async function(t,r,e=u,n=f,i=w){let o;n("Fetching resource structure.");for(let e=1;o=await S(t,r),o[0];e++){n("Failed to fetched resource structure.");if(!await i(e)){return[o[0],undefined]}}o=o[1];n("Successfully fetched resource structure.");n("Fetching download links.");let s=await C(t,r);if(s[0]){f("Failed to fetch download links.");return[s[0],undefined]}s=s[1];n("Successfully fetched download links.");n("Resource structure of cource %s:".format(r));n(o[0].serializable);let a=await e("The ID of the resource / resource tree you would like to download: ");n("Fetching resource information. This may take up to a minute.");let l=await v(t,r,o[2][a],s);if(l[0]){f("Failed to fetch resource information.");return[l[0],undefined]}return[false,l[1]]};let N=async function(e,r,n,t=w){let i="",o="",s={};for(let t of r){let e=n.concat(t.path);s[e.join("/")]=true;e=e.concat([p(t.resTitle+"."+t.format)]);i+="curl '"+"https://abook.hep.com.cn/ICourseFiles/"+t.resFileUrl+"' -o '"+e.join("/")+"'"+"\n"}for(let e in s){o+="mkdir -p '"+e+"'\n"}return o+i};(async function e(){let r=h(t.defaults({jar:t.jar(),forever:true}));let n={};while(true){let e=await u("Username: ");let t=await u("Password: ");f("login().");if(!await g(r,e,t)){f("login() succeeded.");n.userName=e;n.password=t;break}f("login() failed.")}let i;let o=function(t){f("There are %s course(s) available: ".format(t.len));for(let e of s(t.len)){f(e,t[e][0],t[e][1])}};while(true){while(true){f("Fetching course list.");i=await I(r);if(i[0]){f("Failed to fetched course list. Retry in 1 second.");await l(1e3)}else{i=i[1];f("Successfully fetched course list.");break}}o(i);while(true){let t=(await u("Course number / ID, or R to reload, Q to quit: ")).toLowerCase();if(t==="r"){break}if(t==="q"){return}if(t!==""&&!isNaN(t)&&t<i.len){t=i[t][0]}if(t!==""&&!isNaN(t)&&t>5e9){let e=await O(r,t);if(e[0]){o(i);continue}f("Use the following command to download:");f(await N(r,e[1],["downloads",p(i[t][1])]));f();o(i);continue}f("Invalid input.")}}})()})();
